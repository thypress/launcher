<!-- templates/partials/_minisearch.hbs -->
<!--
SPDX-FileCopyrightText: 2026 Teo Costa (THYPRESS <https://thypress.org>)
SPDX-License-Identifier: MPL-2.0
-->
<script src="https://cdn.jsdelivr.net/npm/minisearch@7.1.0/dist/umd/index.min.js"></script>
<script>
  let miniSearch;
  const searchInput = document.getElementById('search-input');
  const searchResults = document.getElementById('search-results');
  const pagesList = document.getElementById('pages-list');

  fetch('/search.json')
    .then(r => r.json())
    .then(data => {
      miniSearch = new MiniSearch({
        fields: ['title', 'content', 'tags', 'description'],
        storeFields: ['title', 'slug', 'url', 'date', 'description'],
        searchOptions: {
          boost: { title: 2, description: 1.5 },
          fuzzy: 0.2,
          prefix: true
        }
      });

      miniSearch.addAll(data);
    })
    .catch(err => console.error('Search failed:', err));

  searchInput.addEventListener('input', (e) => {
    const query = e.target.value.trim();

    if (!query) {
      searchResults.style.display = 'none';
      pagesList.style.display = 'block';
      return;
    }

    if (!miniSearch) {
      searchResults.textContent = '';
      const loadingP = document.createElement('p');
      loadingP.textContent = 'Loading...';
      searchResults.appendChild(loadingP);
      searchResults.style.display = 'block';
      return;
    }

    const results = miniSearch.search(query);

    searchResults.textContent = '';

    if (results.length === 0) {
      const noResultsP = document.createElement('p');
      noResultsP.textContent = 'No results found.';
      searchResults.appendChild(noResultsP);
    } else {
      results.slice(0, 10).forEach(result => {
        const resultDiv = document.createElement('div');
        resultDiv.className = 'search-result';

        const h4 = document.createElement('h4');
        const a = document.createElement('a');
        a.href = result.url;
        a.textContent = result.title;
        h4.appendChild(a);

        const metaDiv = document.createElement('div');
        metaDiv.className = 'meta';
        metaDiv.textContent = result.date;

        resultDiv.appendChild(h4);
        resultDiv.appendChild(metaDiv);

        if (result.description) {
          const descP = document.createElement('p');
          descP.textContent = result.description;
          resultDiv.appendChild(descP);
        }

        searchResults.appendChild(resultDiv);
      });
    }

    searchResults.style.display = 'block';
    pagesList.style.display = 'none';
  });

  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
      if (searchInput.value === '') {
        searchResults.style.display = 'none';
        pagesList.style.display = 'block';
      }
    }
  });
</script>
