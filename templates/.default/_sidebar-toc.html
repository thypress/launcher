<!-- SPDX-License-Identifier: MPL-2.0

This Source Code Form is subject to the terms of the Mozilla Public
License, v. 2.0. If a copy of the MPL was not distributed with this
file, You can obtain one at https://mozilla.org/MPL/2.0/.
-->

{{#if hasToc}}
<aside class="sidebar-toc">
  <h2>On This Page</h2>
  <nav class="toc">
    {{> _toc-tree items=toc}}
  </nav>
</aside>

<script>
(function () {
  const headings = Array.from(
    document.querySelectorAll('article h2[id], article h3[id], article h4[id]')
  );
  const tocAnchors = Array.from(document.querySelectorAll('.toc a[href^="#"]'));
  if (!headings.length || !tocAnchors.length) return;

  const linkById = new Map();
  for (const a of tocAnchors) {
    const raw = a.getAttribute('href').slice(1);
    const id = decodeURIComponent(raw);
    linkById.set(id, a);
  }

  let activeId = null;

  function setActive(id) {
    if (!id || id === activeId) return;
    activeId = id;

    const prev = document.querySelector('.toc a.active');
    if (prev) prev.classList.remove('active');

    const a = linkById.get(id);
    if (a) a.classList.add('active');
  }

  const root = document.documentElement;
  const body = document.body;

  const scrollPadTop =
    parseFloat(getComputedStyle(root).scrollPaddingTop) ||
    parseFloat(getComputedStyle(body).scrollPaddingTop) ||
    0;

  const scrollMarginTop =
    parseFloat(getComputedStyle(headings[0]).scrollMarginTop) || 0;

  const offset = Math.max(scrollPadTop, scrollMarginTop) + 8;

  function computeActiveFromScroll() {
    let current = headings[0].id;
    for (const h of headings) {
      const top = h.getBoundingClientRect().top;
      if (top <= offset) current = h.id;
      else break;
    }
    return current;
  }

  let ticking = false;
  function onScrollOrResize() {
    if (ticking) return;
    ticking = true;
    requestAnimationFrame(() => {
      ticking = false;
      setActive(computeActiveFromScroll());
    });
  }

  window.addEventListener('scroll', onScrollOrResize, { passive: true });
  window.addEventListener('resize', onScrollOrResize);

  // Click: NO immediate setActive -> background will "travel" during smooth scroll.
  for (const a of tocAnchors) {
    a.addEventListener('click', (e) => {
      const id = decodeURIComponent(a.getAttribute('href').slice(1));
      const target = document.getElementById(id);
      if (!target) return;

      e.preventDefault();
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      history.pushState(null, null, `#${encodeURIComponent(id)}`);
    });
  }

  if (location.hash) {
    const id = decodeURIComponent(location.hash.slice(1));
    if (linkById.has(id)) setActive(id);
  }
  setActive(computeActiveFromScroll());
})();
</script>
{{/if}}
