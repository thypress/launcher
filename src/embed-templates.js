// Copyright (C) 2026 THYPRESS

// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU Affero General Public License as
// published by the Free Software Foundation, either version 3 of the
// License, or (at your option) any later version.

// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU Affero General Public License for more details.

// You should have received a copy of the GNU Affero General Public License
// along with this program.  If not, see <https://www.gnu.org>.

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = fileURLToPath(new URL('.', import.meta.url));
const templatesDir = path.join(__dirname, '../templates/.default');
const outputFile = path.join(__dirname, 'embedded-templates.js');

/**
 * Recursively scan directory and collect all template files
 */
function scanTemplates(dir, basePath = '', depth) {
  if (depth > 20) { // Depth check
    console.warn(`Max depth reached in ${dir}`);
    return {};
  }

  const templates = {};

  if (!fs.existsSync(dir)) {
    console.error(`ERROR: Default template directory not found: ${dir}`);
    process.exit(1);
  }

  const entries = fs.readdirSync(dir, { withFileTypes: true });

  for (const entry of entries) {
    // Skip hidden files/folders
    if (entry.name.startsWith('.')) continue;

    const fullPath = path.join(dir, entry.name);
    const relativePath = basePath ? `${basePath}/${entry.name}` : entry.name;

    if (entry.isDirectory()) {
      // Recurse into subdirectories
      Object.assign(templates, scanTemplates(fullPath, relativePath, depth + 1));
    } else if (entry.isFile()) {
      // Include relevant file types
      const ext = path.extname(entry.name).toLowerCase();
      const validExtensions = ['.html', '.css', '.js', '.txt', '.xml', '.json'];

      if (validExtensions.includes(ext)) {
        try {
          templates[relativePath] = fs.readFileSync(fullPath, 'utf-8');
        } catch (error) {
          console.warn(`Warning: Could not read ${relativePath}: ${error.message}`);
        }
      }
    }
  }

  return templates;
}

// Scan and collect all templates
const templates = scanTemplates(templatesDir);

// Validate critical files exist
const criticalFiles = ['index.html', 'entry.html', 'style.css'];
const missing = criticalFiles.filter(file => !templates[file]);

if (missing.length > 0) {
  console.error(`ERROR: Missing critical template files: ${missing.join(', ')}`);
  process.exit(1);
}

// Calculate statistics
const stats = {
  total: Object.keys(templates).length,
  html: Object.keys(templates).filter(k => k.endsWith('.html')).length,
  css: Object.keys(templates).filter(k => k.endsWith('.css')).length,
  js: Object.keys(templates).filter(k => k.endsWith('.js')).length,
  other: Object.keys(templates).filter(k =>
    !k.endsWith('.html') && !k.endsWith('.css') && !k.endsWith('.js')
  ).length
};

const totalSize = Object.values(templates).reduce((sum, content) => sum + content.length, 0);
const sizeMB = (totalSize / 1024 / 1024).toFixed(2);

// Generate output with metadata
const output = `// AUTO-GENERATED - DO NOT EDIT
// Generated: ${new Date().toISOString()}
// Source: templates/.default/
// Total files: ${stats.total}
// Size: ${sizeMB}MB
//
// Breakdown:
//   - ${stats.html} HTML templates
//   - ${stats.css} CSS files
//   - ${stats.js} JavaScript files
//   - ${stats.other} other assets
//
// This file is automatically generated by src/embed-templates.js
// Run: bun src/embed-templates.js to regenerate

export const EMBEDDED_TEMPLATES = ${JSON.stringify(templates, null, 2)};
`;

fs.writeFileSync(outputFile, output);

console.log(`âœ“ Successfully embedded ${stats.total} template files`);
console.log(`- ${stats.html} HTML templates`);
console.log(`- ${stats.css} CSS files`);
console.log(`- ${stats.js} JavaScript files`);
console.log(`- ${stats.other} other assets`);
console.log(`Total size: ${sizeMB}MB`);
console.log(`Output: ${outputFile}`);
